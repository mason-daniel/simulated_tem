     
    program testLib_LinkCell3D
!---^^^^^^^^^^^^^^^^^^^^^^^^^^^
!*  
!*      simple program to test functioning of Lib_LinkCell3D
!*      
!*          successful result        
!*          
!*           Lib_LinkCell3D::LinkCell3D_ctor0() info - allocating          120  cells with            6  atoms per cell
!*           Lib_LinkCell3D::LinkCell3D_ctor0() info - memory cost    2.05993652E-02  Mb
!*          LinkCell3D [Nmax0/cell =    6,nPoints =      200,nNodes =      120]
!*              Supercell[Nx,Ny,Nz =    6,   4,   5 ]
!*                lattice vectors
!*                    1.00000000    0.00000000    0.00000000
!*                    0.00000000    1.00000000    0.00000000
!*                    0.00000000    0.00000000    1.00000000
!*           number of atoms                     200
!*           max storage per cell                 11
!*           max count in any cell                12
!*           max neighbours returned             200
!*          atom 100 at       0.77459828      3.75524794      2.80283356 cf       0.77459828      3.75524794      2.80283356
!*          nearest neighbour       0.45734001      3.62915128      2.80435029 dx      -0.31725826     -0.12609665      0.00151673 |dx|       0.34140221      0.34140221
!*          neigh      1 id     50 dx      -0.31725826     -0.12609665      0.00151673 |dx|       0.34140221
!*          neigh      2 id     53 dx      -0.24080166     -0.31712931     -0.52690314 |dx|       0.66044179
!*          neigh      3 id    100 dx       0.00000000      0.00000000      0.00000000 |dx|       0.00000000
!*          neigh      4 id    104 dx      -0.22581004     -0.64023415      0.07089536 |dx|       0.68258047
!*          neigh      5 id    120 dx      -0.69620773      0.00330332      0.12075079 |dx|       0.70660942
!*          neigh      6 id     89 dx       0.83630137     -0.19430627     -0.38798724 |dx|       0.94217250
!*          neigh      7 id     16 dx      -0.69848830      0.62854956     -0.15739789 |dx|       0.95275104
!*          neigh      8 id    137 dx       0.39093422      0.80978595     -0.18376884 |dx|       0.91779836
!*          neigh      9 id      8 dx       0.15950047     -0.86013141      0.46117604 |dx|       0.98891343
!*          neigh     10 id     11 dx      -0.31253078     -0.24990728      0.21539760 |dx|       0.45445051
!*          neigh     11 id     22 dx      -0.01600407      0.23482891      0.84260992 |dx|       0.87486697
!*          neigh     12 id     83 dx       0.38697241     -0.71150648      0.30923761 |dx|       0.86695849
!*          neigh     13 id    184 dx      -0.32778473      0.47024206      0.50438495 |dx|       0.76352774
!*          neigh exc self     50    53   104   120    89    16   137     8    11    22    83   184
!*          
!*           done
!*          
!*              
!*          
        use iso_fortran_env
        use Lib_SimpleSupercells
        use Lib_ColouredTerminal
        use Lib_LinkCell3D
         
        implicit none
        
        type(LinkCell3D)                        ::      lc3d
        real(kind=real64),dimension(3,3)        ::      a_cell = reshape( (/ 1,0,0,0,1,0,0,0,1 /),(/ 3,3 /) )
        integer                                 ::      Nx = 6, Ny = 4 , Nz = 5
        
        integer                                 ::      nAtoms , nMax    
!        real(kind=real64),dimension(3,3)        ::      a_super
        integer                                 ::       ix,iy,iz,ik,id,nn
        real(kind=real64),dimension(3)          ::      yy,dy
        real(kind=real64)                       ::      dd
        
        
        real(kind=real64),dimension(:,:),allocatable    ::      dx
        integer,dimension(:),allocatable                ::      neigh
        real(kind=real64),dimension(:),allocatable      ::      dr2
        
        
    !---   set of random positions generated for the purpose of the test.
        real(kind=real64),dimension(3,200)      ::  xx = reshape(   (/      0.1825839648d0,3.2357160561d0,0.3118389265d0,           &
                                                                            1.8630691712d0,3.5710998419d0,3.4157456149d0,           &
                                                                            2.3076680457d0,3.8793907534d0,2.6206255181d0,           &
                                                                            0.8564454897d0,1.5513790245d0,1.4744163065d0,           &
                                                                            2.0391655468d0,0.8576087702d0,3.8488445936d0,           &
                                                                            2.6371186801d0,0.9790066127d0,4.6463792847d0,           &
                                                                            1.8041328991d0,1.9599064126d0,1.6991385175d0,           &
                                                                            0.9340987430d0,2.8951165270d0,3.2640095959d0,           &
                                                                            1.5907772823d0,2.2696001504d0,2.9397492804d0,           &
                                                                            1.1201809864d0,1.4790175582d0,0.0557688079d0,           &
                                                                            0.4620674936d0,3.5053406585d0,3.0182311556d0,           &
                                                                            2.9439089479d0,0.5286103495d0,1.3125835008d0,           &
                                                                            1.0829252705d0,2.7080689236d0,1.5143227056d0,           &
                                                                            0.6061192147d0,0.3470555501d0,1.1316686548d0,           &
                                                                            2.7150413615d0,1.4528638199d0,1.2496953205d0,           &
                                                                            0.0761099767d0,0.3837974925d0,2.6454356735d0,           &
                                                                            2.1523730199d0,1.3414934642d0,1.2857469201d0,           &
                                                                            2.3149523575d0,1.1255995719d0,2.5833768000d0,           &
                                                                            2.1081252672d0,0.7274569334d0,1.6582921063d0,           &
                                                                            0.0546748240d0,1.8168075234d0,3.0938546755d0,           &
                                                                            0.4604414547d0,1.0147938706d0,0.6032155648d0,           &
                                                                            0.7585942043d0,3.9900768513d0,3.6454434758d0,           &
                                                                            0.3104877200d0,0.6558354276d0,1.6292902334d0,           &
                                                                            0.5272132493d0,3.8541092234d0,4.7924928690d0,           &
                                                                            1.2230445819d0,1.4881734021d0,2.3947504294d0,           &
                                                                            2.6449236160d0,3.0221299888d0,4.5674277289d0,           &
                                                                            0.8527247751d0,0.9993620258d0,0.6595884560d0,           &
                                                                            2.2725754312d0,0.0367288982d0,0.5520701754d0,           &
                                                                            2.3230295925d0,0.7144474515d0,2.1217009685d0,           &
                                                                            2.1032384469d0,1.3443836994d0,4.3801778770d0,           &
                                                                            1.8255893345d0,2.2454824164d0,3.3817341559d0,           &
                                                                            2.4275525287d0,2.2566657857d0,2.7940691849d0,           &
                                                                            1.6323873125d0,1.1085815061d0,2.6416867407d0,           &
                                                                            1.0125127968d0,3.2255695825d0,0.2314707401d0,           &
                                                                            0.3476020385d0,2.0533467322d0,0.8782185035d0,           &
                                                                            0.3649354542d0,0.0921390705d0,0.4462135515d0,           &
                                                                            2.9949689659d0,0.7816910222d0,2.3802088860d0,           &
                                                                            0.2529018743d0,3.9645829675d0,4.1513900951d0,           &
                                                                            1.2934210944d0,0.9498231740d0,0.9619844707d0,           &
                                                                            0.9576013053d0,2.1253916329d0,4.3233092441d0,           &
                                                                            2.1386057480d0,3.2776564297d0,4.4545660268d0,           &
                                                                            1.3367743117d0,2.9404973408d0,3.3389647773d0,           &
                                                                            2.2049198288d0,1.3498833936d0,2.5121226126d0,           &
                                                                            2.2489944311d0,0.1769180509d0,1.3691626305d0,           &
                                                                            1.5797083233d0,1.3270269677d0,4.5187898037d0,           &
                                                                            0.8026158047d0,0.0019916055d0,0.8440375511d0,           &
                                                                            2.7635255376d0,1.5660176303d0,0.5348709146d0,           &
                                                                            2.6279111506d0,0.1566047283d0,3.2836528941d0,           &
                                                                            0.6900380362d0,1.6122282503d0,3.3004372604d0,           &
                                                                            0.4573400134d0,3.6291512850d0,2.8043502935d0,           &
                                                                            2.1817266256d0,0.3735582936d0,4.1177467114d0,           &
                                                                            0.4883230100d0,3.8325953966d0,1.6451013208d0,           &
                                                                            0.5337966128d0,3.4381186312d0,2.2759304225d0,           &
                                                                            1.2198648938d0,3.9247199079d0,1.9035344995d0,           &
                                                                            0.4490241210d0,0.7116370366d0,1.1422048607d0,           &
                                                                            2.0281091515d0,2.5587542891d0,0.7578403312d0,           &
                                                                            2.7627435127d0,0.4894281085d0,0.5872874241d0,           &
                                                                            0.1971558469d0,1.4028672342d0,4.1741497436d0,           &
                                                                            0.8520434993d0,3.7817840043d0,0.2055688778d0,           &
                                                                            2.6528812487d0,0.0101405337d0,4.3200362066d0,           &
                                                                            2.3102600936d0,1.7878923186d0,0.3417848276d0,           &
                                                                            1.7798768013d0,0.8912500218d0,0.1002043094d0,           &
                                                                            1.5541889930d0,0.7609178445d0,3.1761560617d0,           &
                                                                            1.4983344640d0,2.8960142929d0,0.8651027085d0,           &
                                                                            1.9298790495d0,2.7379876916d0,4.0932289743d0,           &
                                                                            2.4168419823d0,1.8203408212d0,3.0520307179d0,           &
                                                                            0.0635471472d0,2.5265549131d0,1.6137533268d0,           &
                                                                            0.5204650196d0,1.0113400288d0,3.8140907382d0,           &
                                                                            0.5546133166d0,0.7306553607d0,1.3013124019d0,           &
                                                                            1.3681306463d0,2.4383978308d0,4.6399677997d0,           &
                                                                            0.2273452686d0,0.0496027741d0,1.3331526714d0,           &
                                                                            2.8294300380d0,3.9755042275d0,2.0345019541d0,           &
                                                                            1.8349905163d0,0.0207847858d0,1.5827685679d0,           &
                                                                            1.0121146028d0,1.6062135928d0,1.2407494922d0,           &
                                                                            0.7069338916d0,1.5065586530d0,0.5959453385d0,           &
                                                                            1.3095240489d0,0.8543266527d0,1.2318790283d0,           &
                                                                            0.1849064558d0,2.3031151350d0,3.9429248442d0,           &
                                                                            2.3820900776d0,2.9509436749d0,4.1704252685d0,           &
                                                                            0.6061192785d0,1.2060852799d0,3.0717380747d0,           &
                                                                            1.5063269546d0,2.0225340227d0,4.5083798994d0,           &
                                                                            2.1397437722d0,0.4251693866d0,1.5958370903d0,           &
                                                                            0.5830472671d0,2.6556786662d0,0.9680184848d0,           &
                                                                            1.1615706868d0,3.0437414522d0,3.1120711686d0,           &
                                                                            1.4815063838d0,2.6904035764d0,0.8923955636d0,           &
                                                                            0.7617798494d0,1.8408322323d0,0.4557300767d0,           &
                                                                            2.0151832047d0,2.4021102935d0,1.4972763091d0,           &
                                                                            2.8561631092d0,1.4685941108d0,1.3553968390d0,           &
                                                                            0.1575055441d0,2.4659822090d0,2.7218570235d0,           &
                                                                            1.6108996483d0,3.5609416670d0,2.4148463172d0,           &
                                                                            1.8298351996d0,0.7619600376d0,2.2296132802d0,           &
                                                                            2.7750654627d0,1.6805056572d0,3.3108329473d0,           &
                                                                            0.2919420460d0,3.0147481107d0,3.8523792244d0,           &
                                                                            0.6605860344d0,3.1793203646d0,4.0383609324d0,           &
                                                                            0.3885129017d0,0.8012260578d0,0.4797366188d0,           &
                                                                            2.4553566333d0,3.0541126771d0,3.1340667065d0,           &
                                                                            0.6163695306d0,3.2659603882d0,1.6951321717d0,           &
                                                                            2.5458456000d0,3.8957299246d0,4.2474379601d0,           &
                                                                            0.4382361359d0,0.6890546344d0,1.7116559455d0,           &
                                                                            1.0650049081d0,1.3696142330d0,1.1942869504d0,           &
                                                                            0.7745982759d0,3.7552479364d0,2.8028335596d0,           &
                                                                            0.6001502839d0,0.6328946391d0,0.7043532483d0,           &
                                                                            1.7141617784d0,2.6268618065d0,2.1976679517d0,           &
                                                                            0.3507959909d0,1.5101077112d0,1.5180192769d0,           &
                                                                            0.5487882382d0,3.1150137856d0,2.8737289208d0,           &
                                                                            2.6537980617d0,2.5883331553d0,1.1993119087d0,           &
                                                                            2.7634511285d0,2.2881841687d0,1.8326864414d0,           &
                                                                            0.0244193274d0,1.2663645082d0,2.8300431739d0,           &
                                                                            2.4356790409d0,3.6570680070d0,4.5418378699d0,           &
                                                                            0.2043633233d0,1.9437524598d0,0.8379164307d0,           &
                                                                            2.5265392277d0,2.9203906482d0,2.6927940078d0,           &
                                                                            2.1448200498d0,0.1898714975d0,0.9397904624d0,           &
                                                                            1.7011185374d0,0.2956753363d0,1.0051772694d0,           &
                                                                            1.7032906000d0,0.1245867589d0,3.2415312217d0,           &
                                                                            0.5034514763d0,0.2865868511d0,4.5119925465d0,           &
                                                                            2.4066781979d0,0.3267053602d0,4.2362589194d0,           &
                                                                            1.6932251383d0,3.7500878484d0,0.4426929266d0,           &
                                                                            0.4241459566d0,0.7666757040d0,3.9968871342d0,           &
                                                                            2.2283059162d0,2.4069695410d0,3.5713750588d0,           &
                                                                            0.0919862540d0,0.5532015759d0,1.9899586732d0,           &
                                                                            0.0783905428d0,3.7585512541d0,2.9235843503d0,           &
                                                                            1.4683574778d0,2.3687519302d0,3.3780014254d0,           &
                                                                            2.6763947649d0,2.1184690393d0,4.9250323954d0,           &
                                                                            1.3969920635d0,2.2973671246d0,1.1742067528d0,           &
                                                                            1.4324002621d0,2.3042014429d0,2.2007778545d0,           &
                                                                            0.9472937480d0,2.3053625220d0,1.5380294979d0,           &
                                                                            2.2661286628d0,3.2073897960d0,0.3063531356d0,           &
                                                                            0.9173966843d0,2.6535892436d0,4.8323664029d0,           &
                                                                            1.9090679711d0,0.9749521258d0,1.9014787348d0,           &
                                                                            2.3015822403d0,1.9807927637d0,4.3174056864d0,           &
                                                                            1.9784969309d0,1.7773417603d0,0.7696219539d0,           &
                                                                            2.0684194152d0,2.9684617917d0,3.0110433966d0,           &
                                                                            0.7543878386d0,1.9595536366d0,2.3541776100d0,           &
                                                                            0.2558015456d0,0.2548021769d0,1.6866788688d0,           &
                                                                            1.6846294291d0,0.1702685409d0,4.1913380996d0,           &
                                                                            0.1484150648d0,0.2905131590d0,4.7920550658d0,           &
                                                                            0.9136447981d0,1.0379717796d0,3.4115314463d0,           &
                                                                            1.1655324910d0,0.5650338852d0,2.6190647178d0,           &
                                                                            0.6399845814d0,0.2974320918d0,0.4930816438d0,           &
                                                                            2.1675332460d0,3.3811320974d0,2.7243123723d0,           &
                                                                            0.4438078341d0,3.7178660341d0,0.9058264312d0,           &
                                                                            0.1782568691d0,3.0552205948d0,1.2575583589d0,           &
                                                                            2.2408991008d0,3.6144149551d0,4.9277756880d0,           &
                                                                            1.9594943512d0,3.6486588814d0,4.4298851702d0,           &
                                                                            0.5335762750d0,2.1081218833d0,0.4392272881d0,           &
                                                                            0.0416722582d0,2.7811307572d0,1.4497045138d0,           &
                                                                            1.4760389147d0,2.5807063538d0,1.0506452900d0,           &
                                                                            1.7489406303d0,3.1476927558d0,1.2806952879d0,           &
                                                                            0.4282959323d0,3.0201220503d0,1.8734078984d0,           &
                                                                            2.2781262028d0,0.0808265254d0,2.4362762319d0,           &
                                                                            0.3289282653d0,2.9839051114d0,3.4418465559d0,           &
                                                                            0.6599688125d0,0.5362806110d0,1.7587433084d0,           &
                                                                            2.1327990129d0,0.0864077018d0,1.9807817583d0,           &
                                                                            1.7510078338d0,1.9153785735d0,0.8115385596d0,           &
                                                                            1.6139360043d0,0.5452449987d0,0.5952629967d0,           &
                                                                            0.4528143017d0,1.9726641636d0,1.7214708961d0,           &
                                                                            2.6309013510d0,3.0945433131d0,3.4533210517d0,           &
                                                                            1.6409062387d0,3.4483257146d0,0.3869824520d0,           &
                                                                            0.3967155460d0,1.3374065198d0,1.2074527805d0,           &
                                                                            1.7213895355d0,3.3520719951d0,4.6414944439d0,           &
                                                                            1.0972202077d0,1.3838106369d0,1.8438506669d0,           &
                                                                            2.9861872092d0,3.5600779802d0,2.2859857402d0,           &
                                                                            0.1314188224d0,3.5193592283d0,3.8706151979d0,           &
                                                                            0.8509648904d0,0.7764255934d0,1.0050559150d0,           &
                                                                            0.9595753668d0,1.6037758629d0,0.4137803863d0,           &
                                                                            1.7390138375d0,3.9847661777d0,1.4391797648d0,           &
                                                                            0.5019966473d0,1.9728945818d0,4.4951885568d0,           &
                                                                            1.6937164840d0,0.1571026161d0,4.4237369751d0,           &
                                                                            2.2014234953d0,1.2106677272d0,3.7486178637d0,           &
                                                                            2.4034954934d0,0.3806403120d0,0.3962791988d0,           &
                                                                            2.1791241120d0,2.0760528840d0,0.1648559857d0,           &
                                                                            2.4454264788d0,2.4893174974d0,4.4898311006d0,           &
                                                                            0.1519918992d0,3.9815090694d0,3.7400488822d0,           &
                                                                            0.3342820170d0,2.9868759891d0,1.5415518304d0,           &
                                                                            2.0968760333d0,0.2066393892d0,4.5071970858d0,           &
                                                                            1.5285671866d0,3.8519754399d0,2.1403790265d0,           &
                                                                            1.8261124846d0,2.8182217682d0,3.1274434122d0,           &
                                                                            2.1923393544d0,1.9301407146d0,1.3158303577d0,           &
                                                                            2.3723501902d0,3.2126119667d0,1.2050358556d0,           &
                                                                            2.6169987536d0,0.9730256740d0,3.7377276557d0,           &
                                                                            1.6693018430d0,3.1080322359d0,3.1221201523d0,           &
                                                                            2.9513527783d0,2.7303154748d0,2.4357316936d0,           &
                                                                            1.4049920199d0,2.0715028023d0,3.3610317763d0,           &
                                                                            2.3090460807d0,3.0508514168d0,1.2955251969d0,           &
                                                                            0.4468135469d0,0.2254899981d0,3.3072185097d0,           &
                                                                            0.8194690837d0,1.7634402980d0,1.6626309919d0,           &
                                                                            1.4293649637d0,0.1054548066d0,4.7474800559d0,           &
                                                                            0.1524638008d0,0.9838871592d0,3.7193822491d0,           &
                                                                            1.3363614533d0,1.6903197322d0,0.4657658067d0,           &
                                                                            1.0046209134d0,3.1308982605d0,0.1438349588d0,           &
                                                                            2.5685484243d0,3.4805792914d0,0.5687529464d0,           &
                                                                            1.9168914966d0,0.2259927228d0,2.4140553809d0,           &
                                                                            0.8693407520d0,3.8757756972d0,0.2489498038d0,           &
                                                                            0.1271302567d0,3.5752513938d0,3.6880747802d0,           &
                                                                            0.3267829152d0,0.9734550369d0,4.6140616489d0,           &
                                                                            1.4844478703d0,0.9833742726d0,1.3927986819d0,           &
                                                                            0.4950599855d0,0.4900514163d0,1.0597928011d0,           &
                                                                            2.1295708185d0,0.6186724393d0,4.2623372422d0,           &
                                                                            0.7997979865d0,0.5544601680d0,4.5530516530d0,           &
                                                                            1.7728842516d0,1.9238691118d0,0.9520439725d0,           &
                                                                            1.5700210399d0,3.2534677004d0,1.5353832434d0  /),(/ 3,200 /) )
                                                                        
        
        

        character(len=256),dimension(20)            ::      output
        character(len=*),dimension(20),parameter   ::      output0 = (/ " number of atoms                     200                                                                                                                    ", &
                                                                        " max storage per cell                 11                                                                                                                    ", &
                                                                        " max count in any cell                12                                                                                                                    ", &
                                                                        " max neighbours returned             200                                                                                                                    ", &
                                                                        "atom 100 at       0.77459828      3.75524794      2.80283356 cf       0.77459828      3.75524794      2.80283356                                            ", &
                                                                        "nearest neighbour       0.45734001      3.62915128      2.80435029 dx      -0.31725826     -0.12609665      0.00151673 |dx|       0.34140221      0.34140221", &                                                            
                                                                        "neigh      1 id     50 dx      -0.31725826     -0.12609665      0.00151673 |dx|       0.34140221                                                            ", &
                                                                        "neigh      2 id     53 dx      -0.24080166     -0.31712931     -0.52690314 |dx|       0.66044179                                                            ", &
                                                                        "neigh      3 id    100 dx       0.00000000      0.00000000      0.00000000 |dx|       0.00000000                                                            ", &
                                                                        "neigh      4 id    104 dx      -0.22581004     -0.64023415      0.07089536 |dx|       0.68258047                                                            ", &
                                                                        "neigh      5 id    120 dx      -0.69620773      0.00330332      0.12075079 |dx|       0.70660942                                                            ", &
                                                                        "neigh      6 id     89 dx       0.83630137     -0.19430627     -0.38798724 |dx|       0.94217250                                                            ", &
                                                                        "neigh      7 id     16 dx      -0.69848830      0.62854956     -0.15739789 |dx|       0.95275104                                                            ", &
                                                                        "neigh      8 id    137 dx       0.39093422      0.80978595     -0.18376884 |dx|       0.91779836                                                            ", &
                                                                        "neigh      9 id      8 dx       0.15950047     -0.86013141      0.46117604 |dx|       0.98891343                                                            ", &
                                                                        "neigh     10 id     11 dx      -0.31253078     -0.24990728      0.21539760 |dx|       0.45445051                                                            ", &
                                                                        "neigh     11 id     22 dx      -0.01600407      0.23482891      0.84260992 |dx|       0.87486697                                                            ", &
                                                                        "neigh     12 id     83 dx       0.38697241     -0.71150648      0.30923761 |dx|       0.86695849                                                            ", &
                                                                        "neigh     13 id    184 dx      -0.32778473      0.47024206      0.50438495 |dx|       0.76352774                                                            ", &
                                                                        "neigh exc self     50    53   104   120    89    16   137     8    11    22    83   184                                                                     " /)
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        
                                                                        
        logical                     ::      ok 
        integer                     ::      ii                                                             
                                                                   
                                                      
        
                                                                            
                                                                            
                                                                            
        
        
        
    !---    estimate the storage required assuming homogeneous distribution
        nAtoms = size(xx,dim=2)
        nMax = estimateMaxCountPerCell( Nx*Ny*Nz,nAtoms )        
        
    !---    construct link cell list 
        lc3d = LinkCell3D_ctor(a_cell,nMax,Nx,Ny,Nz)
        
        
    !---    for the generation of the test: randomly place atoms
    !    call random_number(xx)
    !    a_super = getSuperA( getSuper( lc3d ) )
    !    do ii = 1,nAtoms        
    !        xx(1:3,ii) = a_super(1:3,1)*xx(1,ii) + a_super(1:3,2)*xx(2,ii) + a_super(1:3,3)*xx(3,ii)
    !        write (*,fmt='(3f16.10)') xx(1:3,ii)
    !    end do
    !    
     
        
    !---    add atoms, report    
        call add(lc3d,xx)        
        call report(lc3d)
        
        output=""
        write(output(1),fmt='(a,i6)') "number of atoms            ",getnPoints(lc3d)
        write(output(2),fmt='(a,i6)') "max storage per cell       ",getnMax(lc3d)
        write(output(3),fmt='(a,i6)') "max count in any cell      ",getMaxPerCell(lc3d)
        write(output(4),fmt='(a,i6)') "max neighbours returned    ",getNNeighMax(lc3d)
        
        ii = getNNeighMax(lc3d)
        allocate(dx(3,ii))
        allocate(dr2(ii))
        allocate(neigh(ii))
         
        
        do iz = 0,getNz(lc3d)-1
            do iy = 0,getNy(lc3d)-1
                do ix = 0,getNx(lc3d)-1
                    do ik = 1,getnPoints(lc3d,ix,iy,iz)
                        id = getId(lc3d,ix,iy,iz,ik)
                        if (id == 100) then
                        
                        !---    check nearest neighbour of atom 100
                            yy = getPosition( lc3d,ix,iy,iz,ik,includeCellOffset=.true. )
                            write(output(5),fmt='(a,3f16.8,a,3f16.8)') "atom 100 at ",yy(1:3)," cf ",xx(1:3,100)
                            call nearestNeighbour( lc3d,yy, id,dd,self=.false.,dx=dy )
                            write(output(6),fmt='(3(a,3f16.8))') "nearest neighbour ",xx(1:3,id)," dx ",dy(1:3)," |dx| ",norm2(dy),sqrt(dd)
                            
                        !---    check right answer
                        !    dr2 = huge(1.0)
                        !    do ii = 1,nAtoms
                        !        if (ii == 100) cycle
                        !        dy = minimumImage( getSuper(lc3d),yy(1:3)-xx(1:3,ii) )
                        !        dr2 = min( dr2, norm2( dy ) )
                        !    end do
                        !    print *,"cf real min dist ",dr2     
                         
                        !---    check all neighbours of atom 100
                            call neighbourList( lc3d,yy,1.00d0, nn,neigh,dx,dr2 )
                            do ii = 1,nn
                                write (output(min(6+ii,size(output))),fmt='(2(a,i6),2(a,3f16.8))') "neigh ",ii," id ",neigh(ii) ," dx ",dx(:,ii)," |dx| ",sqrt(dr2(ii))
                            end do
                            
                        !!---    check right answer
                        !    dr2 = huge(1.0)
                        !    do ii = 1,nAtoms
                        !        dy = minimumImage( getSuper(lc3d),yy(1:3)-xx(1:3,ii) )
                        !        if (norm2(dy)<=1.00d0) write (*,fmt='(a,i6,2(a,3f16.8))') " id ",ii ," dx ",dy," |dx| ",norm2(dy)
                        !    end do
                            
                        !---    all neighbours different call
                            call neighbourList( lc3d,ix,iy,iz,ik,1.00d0, nn,neigh  )  
                            write (output(size(output)),fmt='(a,1000i6)') "neigh exc self ",neigh(1:nn)
                            
                        
                                   
                        end if  
                    end do
                end do
            end do
        end do
        
        
    !---    here is the simple test: does the output look like the stored output?
        ok = .true.
        do ii = 1,size(output)            
            if ( trim(cutSpaces(output(ii))) == trim(cutSpaces(output0(ii))) ) then
                write (*,fmt='(a)') trim(cutSpaces(output(ii)))
            else
                ok = .false.
                write (*,fmt='(a)') trim(cutSpaces(output0(ii)))//"    "//colour(RED,trim(cutSpaces(output(ii))))
            end if
        end do   
        
       
    !---    output the result "PASS" or "FAIL"    
        if (ok) then
            print *,colour(LIGHT_GREEN,"PASS")
        else
            print *,colour(RED,"FAIL")
        end if
        
        
        
        print *,""
        print *,"done"
        print *,""
        
    end program testLib_LinkCell3D
        
        